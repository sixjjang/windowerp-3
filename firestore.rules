rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자 인증 확인 함수
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 관리자 권한 확인 함수
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // 직원 권한 확인 함수
    function isStaff() {
      return isAuthenticated() && 
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'staff' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // 본인 데이터 확인 함수
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // 사용자 컬렉션
    match /users/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isStaff());
      allow create: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // 일정 컬렉션
    match /schedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && isStaff();
    }
    
    // 견적서 컬렉션
    match /estimates/{estimateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && isStaff();
    }
    
    // 계약 컬렉션
    match /contracts/{contractId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && isStaff();
    }
    
    // 배송 컬렉션
    match /deliveries/{deliveryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && isStaff();
    }
    
    // 고객 컬렉션
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && isStaff();
    }
    
    // 제품 컬렉션
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isStaff();
      allow update: if isAuthenticated() && isStaff();
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // 과거자료 컬렉션
    match /historicalData/{fileId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && isStaff();
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // 알림 컬렉션
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
  }
} 